# 2_load_raw_data_to_supabase.py (Updated Version)
import os
import json
import toml  # <-- IMPORT TOML
from supabase import create_client, Client

# --- List of game IDs to process (should match the fetch script) ---
GAME_IDS_TO_FETCH = [
    "2024020911",
    "2024020912",
    "2024020913",
    "2024020914",
    "2024020915",
    "2024020916",
    "2024020917",
    "2024020918",
    "2024020919",
    "2024020920",
    "2024020921",
    "2024020922",
    "2024020923",
    "2024020924",
    "2024020925",
    "2024020926",
    "2024020927",
    "2024020928",
    "2024020929",
    "2024020930",
    "2024020931",
    "2024020932",
    "2024020933",
    "2024020934",
    "2024020935",
    "2024020936",
    "2024020937",
    "2024020938",
    "2024020939",
    "2024020940",
    "2024020941",
    "2024020942",
    "2024020943",
    "2024020944",
    "2024020945",
    "2024020946",
    "2024020947",
    "2024020948",
    "2024020949",
    "2024020950",
    "2024020951",
    "2024020952",
    "2024020953",
    "2024020954",
    "2024020955",
    "2024020956",
    "2024020957",
    "2024020958",
    "2024020959",
    "2024020960",
    "2024020961",
    "2024020962",
    "2024020963",
    "2024020964",
    "2024020965",
    "2024020966",
    "2024020967",
    "2024020968",
    "2024020969",
    "2024020970",
    "2024020971",
    "2024020972",
    "2024020973",
    "2024020974",
    "2024020975",
    "2024020976",
    "2024020977",
    "2024020978",
    "2024020979",
    "2024020980",
    "2024020981",
    "2024020982",
    "2024020983",
    "2024020984",
    "2024020985",
    "2024020986",
    "2024020987",
    "2024020988",
    "2024020989",
    "2024020990",
    "2024020991",
    "2024020992",
    "2024020993",
    "2024020994",
    "2024020995",
    "2024020996",
    "2024020997",
    "2024020998",
    "2024020999",
    "2024021000",
    "2024021001",
    "2024021002",
    "2024021003",
    "2024021004",
    "2024021005",
    "2024021006",
    "2024021007",
    "2024021008",
    "2024021009",
    "2024021010",
    "2024021011",
    "2024021012",
    "2024021013",
    "2024021014",
    "2024021015",
    "2024021016",
    "2024021017",
    "2024021018",
    "2024021019",
    "2024021020",
    "2024021021",
    "2024021022",
    "2024021023",
    "2024021024",
    "2024021025",
    "2024021026",
    "2024021027",
    "2024021028",
    "2024021029",
    "2024021030",
    "2024021031",
    "2024021032",
    "2024021033",
    "2024021034",
    "2024021035",
    "2024021036",
    "2024021037",
    "2024021038",
    "2024021039",
    "2024021040",
    "2024021041",
    "2024021042",
    "2024021043",
    "2024021044",
    "2024021045",
    "2024021046",
    "2024021047",
    "2024021048",
    "2024021049",
    "2024021050",
    "2024021051",
    "2024021052",
    "2024021053",
    "2024021054",
    "2024021055",
    "2024021056",
    "2024021057",
    "2024021058",
    "2024021059",
    "2024021060",
    "2024021061",
    "2024021062",
    "2024021063",
    "2024021064",
    "2024021065",
    "2024021066",
    "2024021067",
    "2024021068",
    "2024021069",
    "2024021070",
    "2024021071",
    "2024021072",
    "2024021073",
    "2024021074",
    "2024021075",
    "2024021076",
    "2024021077",
    "2024021078",
    "2024021079",
    "2024021080",
    "2024021081",
    "2024021082",
    "2024021083",
    "2024021084",
    "2024021085",
    "2024021086",
    "2024021087",
    "2024021088",
    "2024021089",
    "2024021090",
    "2024021091",
    "2024021092",
    "2024021093",
    "2024021094",
    "2024021095",
    "2024021096",
    "2024021097",
    "2024021098",
    "2024021099",
    "2024021100",
    "2024021101",
    "2024021102",
    "2024021103",
    "2024021104",
    "2024021105",
    "2024021106",
    "2024021107",
    "2024021108",
    "2024021109",
    "2024021110",
    "2024021111",
    "2024021112",
    "2024021113",
    "2024021114",
    "2024021115",
    "2024021116",
    "2024021117",
    "2024021118",
    "2024021119",
    "2024021120",
    "2024021121",
    "2024021122",
    "2024021123",
    "2024021124",
    "2024021125",
    "2024021126",
    "2024021127",
    "2024021128",
    "2024021129",
    "2024021130",
    "2024021131",
    "2024021132",
    "2024021133",
    "2024021134",
    "2024021135",
    "2024021136",
    "2024021137",
    "2024021138",
    "2024021139",
    "2024021140",
    "2024021141",
    "2024021142",
    "2024021143",
    "2024021144",
    "2024021145",
    "2024021146",
    "2024021147",
    "2024021148",
    "2024021149",
    "2024021150",
    "2024021151",
    "2024021152",
    "2024021153",
    "2024021154",
    "2024021155",
    "2024021156",
    "2024021157",
    "2024021158",
    "2024021159",
    "2024021160",
    "2024021161",
    "2024021162",
    "2024021163",
    "2024021164",
    "2024021165",
    "2024021166",
    "2024021167",
    "2024021168",
    "2024021169",
    "2024021170",
    "2024021171",
    "2024021172",
    "2024021173",
    "2024021174",
    "2024021175",
    "2024021176",
    "2024021177",
    "2024021178",
    "2024021179",
    "2024021180",
    "2024021181",
    "2024021182",
    "2024021183",
    "2024021184",
    "2024021185",
    "2024021186",
    "2024021187",
    "2024021188",
    "2024021189",
    "2024021190",
    "2024021191",
    "2024021192",
    "2024021193",
    "2024021194",
    "2024021195",
    "2024021196",
    "2024021197",
    "2024021198",
    "2024021199",
    "2024021200",
    "2024021201",
    "2024021202",
    "2024021203",
    "2024021204",
    "2024021205",
    "2024021206",
    "2024021207",
    "2024021208",
    "2024021209",
    "2024021210",
    "2024021211",
    "2024021212",
    "2024021213",
    "2024021214",
    "2024021215",
    "2024021216",
    "2024021217",
    "2024021218",
    "2024021219",
    "2024021220",
    "2024021221",
    "2024021222",
    "2024021223",
    "2024021224",
    "2024021225",
    "2024021226",
    "2024021227",
    "2024021228",
    "2024021229",
    "2024021230",
    "2024021231",
    "2024021232",
    "2024021233",
    "2024021234",
    "2024021235",
    "2024021236",
    "2024021237",
    "2024021238",
    "2024021239",
    "2024021240",
    "2024021241",
    "2024021242",
    "2024021243",
    "2024021244",
    "2024021245",
    "2024021246",
    "2024021247",
    "2024021248",
    "2024021249",
    "2024021250",
    "2024021251",
    "2024021252",
    "2024021253",
    "2024021254",
    "2024021255",
    "2024021256",
    "2024021257",
    "2024021258",
    "2024021259",
    "2024021260",
    "2024021261",
    "2024021262",
    "2024021263",
    "2024021264",
    "2024021265",
    "2024021266",
    "2024021267",
    "2024021268",
    "2024021269",
    "2024021270",
    "2024021271",
    "2024021272",
    "2024021273",
    "2024021274",
    "2024021275",
    "2024021276",
    "2024021277",
    "2024021278",
    "2024021279",
    "2024021280",
    "2024021281",
    "2024021282",
    "2024021283",
    "2024021284",
    "2024021285",
    "2024021286",
    "2024021287",
    "2024021288",
    "2024021289",
    "2024021290",
    "2024021291",
    "2024021292",
    "2024021293",
    "2024021294",
    "2024021295",
    "2024021296",
    "2024021297",
    "2024021298",
    "2024021299",
    "2024021300",
    "2024021301",
    "2024021302",
    "2024021303",
    "2024021304",
    "2024021305",
    "2024021306",
    "2024021307",
    "2024021308",
    "2024021309",
    "2024021310",
    "2024021311",
    "2024021312",
    "2024030111",
    "2024030112",
    "2024030113",
    "2024030114",
    "2024030115",
    "2024030116",
    "2024030117",
    "2024030121",
    "2024030122",
    "2024030123",
    "2024030124",
    "2024030125",
    "2024030126",
    "2024030127",
    "2024030131",
    "2024030132",
    "2024030133",
    "2024030134",
    "2024030135",
    "2024030136",
    "2024030137",
    "2024030141",
    "2024030142",
    "2024030143",
    "2024030144",
    "2024030145",
    "2024030146",
    "2024030147",
    "2024030151",
    "2024030152",
    "2024030153",
    "2024030154",
    "2024030155",
    "2024030156",
    "2024030157",
    "2024030161",
    "2024030162",
    "2024030163",
    "2024030164",
    "2024030165",
    "2024030166",
    "2024030167",
    "2024030171",
    "2024030172",
    "2024030173",
    "2024030174",
    "2024030175",
    "2024030176",
    "2024030177",
    "2024030181",
    "2024030182",
    "2024030183",
    "2024030184",
    "2024030185",
    "2024030186",
    "2024030187",
    "2024030211",
    "2024030212",
    "2024030213",
    "2024030214",
    "2024030215",
    "2024030216",
    "2024030217",
    "2024030221",
    "2024030222",
    "2024030223",
    "2024030224",
    "2024030225",
    "2024030226",
    "2024030227",
    "2024030231",
    "2024030232",
    "2024030233",
    "2024030234",
    "2024030235",
    "2024030236",
    "2024030237",
    "2024030241",
    "2024030242",
    "2024030243",
    "2024030244",
    "2024030245",
    "2024030246",
    "2024030247",
    "2024030311",
    "2024030312",
    "2024030313",
    "2024030314",
    "2024030315",
    "2024030316",
    "2024030317",
    "2024030321",
    "2024030322",
    "2024030323",
    "2024030324",
    "2024030325",
    "2024030326",
    "2024030327",
    "2024030411",
    "2024030412",
    "2024030413",
    "2024030414",
    "2024030415",
    "2024030416",
    "2024030417",]

# --- UPDATED: Load secrets directly from the .toml file ---
# This builds a path from this script's location up to the root and then to the secrets file
try:
    script_dir = os.path.dirname(__file__)
    secrets_path = os.path.join(script_dir, '..', '.streamlit', 'secrets.toml')
    secrets = toml.load(secrets_path)
    
    SUPABASE_URL = secrets["connections"]["supabase"]["SUPABASE_URL"]
    SUPABASE_KEY = secrets["connections"]["supabase"]["SUPABASE_KEY"]
except FileNotFoundError:
    print("Error: secrets.toml not found. Make sure it's in the .streamlit folder in your project root.")
    exit()

# --- Supabase Connection ---
supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# --- Data Location ---
SOURCE_FOLDER = "raw_game_data"

# --- Main Loading Loop ---
for game_id in GAME_IDS_TO_FETCH:
    print(f"\n--- Loading Game ID: {game_id} to Supabase ---")
    
    # 1. Load PBP Data
    pbp_file_path = os.path.join(SOURCE_FOLDER, f"{game_id}_pbp.json")
    try:
        with open(pbp_file_path, 'r', encoding='utf-8') as f:
            pbp_data = json.load(f)
        
        # Upsert ensures we don't create duplicates
        pbp_response = supabase.table('nhl_games_pbp').upsert({
            "game_id": game_id,
            "pbp_data": pbp_data
        }).execute()
        
        if pbp_response.data:
            print(f"✅ PBP data for game {game_id} loaded.")
        else:
            print(f"❌ Error loading PBP data for {game_id}: {pbp_response.error}")

    except FileNotFoundError:
        print(f"⚠️ PBP file not found for game {game_id}, skipping.")
        
    # 2. Load Shift Data
    shift_file_path = os.path.join(SOURCE_FOLDER, f"{game_id}_shifts.json")
    try:
        with open(shift_file_path, 'r', encoding='utf-8') as f:
            shift_data = json.load(f)

        shift_response = supabase.table('nhl_games_shifts').upsert({
            "game_id": game_id,
            "shifts_data": shift_data
        }).execute()

        if shift_response.data:
            print(f"✅ Shift data for game {game_id} loaded.")
        else:
            print(f"❌ Error loading Shift data for {game_id}: {shift_response.error}")

    except FileNotFoundError:
        print(f"⚠️ Shift file not found for game {game_id}, skipping.")

print("\n--- Loading complete! ---")